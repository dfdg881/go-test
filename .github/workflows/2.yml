name: Build True Static Binary

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-true-static:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Install musl for pure static
      run: |
        echo "Installing musl for complete static linking..."
        sudo apt-get update
        sudo apt-get install -y musl-tools musl-dev
        
        # éªŒè¯å®‰è£…
        musl-gcc --version | head -1
    
    - name: Build with musl (å¼ºåˆ¶é™æ€)
      run: |
        echo "Building truly static binary with musl..."
        
        # æ–¹æ³•1: ä½¿ç”¨ musl å¼ºåˆ¶é™æ€
        CC=musl-gcc \
        CGO_ENABLED=1 \
        GOOS=linux \
        GOARCH=amd64 \
        go build \
          -ldflags="-s -w -linkmode=external -extldflags '-static'" \
          -tags "osusergo netgo static" \
          -o epg-true-static \
          .
        
        echo "âœ… Built with musl"
    
    - name: Verify true static
      run: |
        echo "ğŸ” Verifying true static binary..."
        
        if [ ! -f "epg-true-static" ]; then
          echo "âŒ Binary not found!"
          exit 1
        fi
        
        echo "ğŸ“„ File info:"
        file epg-true-static
        echo ""
        
        echo "ğŸ”— Checking dependencies:"
        if readelf -d epg-true-static 2>/dev/null; then
          echo "âŒ Still has ELF dynamic section!"
          readelf -d epg-true-static | head -10
        else
          echo "âœ… No dynamic section (good!)"
        fi
        
        echo ""
        echo "ğŸ” Checking for interpreter:"
        if readelf -l epg-true-static 2>/dev/null | grep -q "INTERP"; then
          echo "âŒ Has interpreter (not fully static)"
          readelf -l epg-true-static | grep -A1 INTERP
        else
          echo "âœ… No interpreter (fully static!)"
        fi
        
        echo ""
        echo "ğŸ“Š Size:"
        ls -lh epg-true-static
    
    - name: Upload true static binary
      uses: actions/upload-artifact@v4
      with:
        name: epg-true-static
        path: epg-true-static