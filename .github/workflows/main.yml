name: Build for OpenWrt ARM64

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Install OpenWrt SDK
      run: |
        echo "Downloading OpenWrt SDK for ARM64..."
        # OpenWrt 23.05.0 ARM64 SDK
        wget -q https://downloads.openwrt.org/releases/23.05.0/targets/armvirt/64/openwrt-sdk-23.05.0-armvirt-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
        tar -xf openwrt-sdk-*.tar.xz
        mv openwrt-sdk-* openwrt-sdk
        
        echo "OpenWrt SDK installed to: $(pwd)/openwrt-sdk"
    
    - name: Build using OpenWrt toolchain
      run: |
        echo "Building with OpenWrt toolchain..."
        
        # ä½¿ç”¨ OpenWrt çš„ musl å·¥å…·é“¾
        TOOLCHAIN_DIR="$(pwd)/openwrt-sdk/staging_dir/toolchain-aarch64_cortex-a53_gcc-12.3.0_musl"
        export STAGING_DIR="$TOOLCHAIN_DIR"
        export PATH="$TOOLCHAIN_DIR/bin:$PATH"
        
        # è®¾ç½®ç¼–è¯‘å™¨
        export CC="aarch64-openwrt-linux-musl-gcc"
        export CXX="aarch64-openwrt-linux-musl-g++"
        
        echo "Compiler: $(which $CC)"
        $CC --version
        
        # æ„å»º
        CGO_ENABLED=1 \
        GOOS=linux \
        GOARCH=arm64 \
        go build \
          -ldflags="-s -w -linkmode=external -extldflags '-static'" \
          -tags "osusergo netgo static" \
          -o epg-openwrt-arm64 \
          .
        
        echo "Build completed"
        file epg-openwrt-arm64
    
    - name: Verify OpenWrt binary
      run: |
        echo "Verifying binary for OpenWrt..."
        BINARY="epg-openwrt-arm64"
        
        if [ -f "$BINARY" ]; then
          echo "âœ… Binary exists"
          echo "ğŸ“„ File info:"
          file "$BINARY"
          
          # æ£€æŸ¥æ˜¯å¦ä¸º ARM64
          if file "$BINARY" | grep -q "ARM aarch64"; then
            echo "âœ… Correct: ARM64"
          else
            echo "âŒ Wrong architecture!"
          fi
          
          # æ£€æŸ¥æ˜¯å¦é™æ€é“¾æ¥
          if file "$BINARY" | grep -q "statically linked"; then
            echo "âœ… Static linked (good for OpenWrt)"
          else
            echo "âš ï¸ Not static!"
          fi
          
          echo "ğŸ“Š Size: $(ls -lh "$BINARY" | awk '{print $5}')"
        else
          echo "âŒ Binary not found!"
        fi
    
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: epg-for-openwrt
        path: epg-openwrt-arm64